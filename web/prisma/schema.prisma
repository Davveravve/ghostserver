generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Player account linked to Steam
model Player {
  id                String   @id @default(cuid())
  steamId           String   @unique
  username          String
  avatarUrl         String?  @db.Text

  // Economy
  souls             Int      @default(0)
  totalSoulsEarned  Int      @default(0)

  // Stats
  playtimeMinutes   Int      @default(0)
  totalKills        Int      @default(0)
  casesOpened       Int      @default(0)

  // Ranking
  elo               Int      @default(1000)
  wins              Int      @default(0)
  losses            Int      @default(0)

  // Premium
  isPremium         Boolean  @default(false)
  premiumTier       String   @default("none") // none, ascended
  premiumExpiresAt  DateTime?

  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastSeenAt        DateTime @default(now())

  // Relations
  inventory         InventoryItem[]
  caseOpens         CaseOpen[]
  transactions      SoulTransaction[]
}

// Item in player's inventory
model InventoryItem {
  id              String   @id @default(cuid())

  // Owner
  playerId        String
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  // Item details (stored for quick access, references items-data.ts)
  itemId          Int
  name            String
  weapon          String
  skinName        String
  wear            String   // FN, MW, FT, WW, BS
  floatValue      Float    // Actual float value when won
  imageUrl        String   @db.Text

  // Doppler phase if applicable
  dopplerPhase    String?

  // Type: skin, knife, gloves
  itemType        String

  // Rarity for sorting/trade-ups
  rarity          String   @default("common") // common, uncommon, rare, epic, legendary, ultra

  // Equip status
  equippedCt      Boolean  @default(false)
  equippedT       Boolean  @default(false)

  // Favorite status
  isFavorite      Boolean  @default(false)

  // How it was obtained
  obtainedAt      DateTime @default(now())
  obtainedFrom    String?  // case name or "drop"

  @@index([playerId])
  @@index([itemType])
  @@index([rarity])
}

// Case opening history
model CaseOpen {
  id          String   @id @default(cuid())

  playerId    String
  player      Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  caseName    String
  caseId      Int

  // Won item
  itemId      Int
  itemName    String
  itemWeapon  String
  itemWear    String
  floatValue  Float

  // Cost
  soulsCost   Int

  createdAt   DateTime @default(now())

  @@index([playerId])
  @@index([createdAt])
}

// Soul transaction history
model SoulTransaction {
  id          String   @id @default(cuid())

  playerId    String
  player      Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  amount      Int      // Positive = earned, Negative = spent
  type        String   // kill, playtime, case_open, admin, bonus
  description String?

  // Balance after transaction
  balanceAfter Int

  createdAt   DateTime @default(now())

  @@index([playerId])
  @@index([createdAt])
}

// Server tracking (for authenticating plugin requests)
model Server {
  id            String   @id @default(cuid())
  name          String
  ip            String?
  port          Int?
  apiKey        String   @unique // For authenticating server requests

  isOnline      Boolean  @default(false)
  currentPlayers Int     @default(0)
  maxPlayers    Int      @default(32)
  currentMap    String?

  lastHeartbeat DateTime?
  createdAt     DateTime @default(now())
}

// Giveaway system
model Giveaway {
  id            String   @id @default(cuid())
  title         String
  description   String?  @db.Text

  // Prize
  prizeType     String   // souls, item, custom
  prizeSouls    Int?     // If prizeType = souls
  prizeItemId   Int?     // If prizeType = item (references items-data.ts)
  prizeCustom   String?  // If prizeType = custom (description of prize)

  // Type: random = random winner, leaderboard = top X players win
  giveawayType  String   @default("random") // random, leaderboard

  // For leaderboard type
  leaderboardType String? // elo, souls, kills
  winnersCount   Int     @default(1) // How many winners

  // Requirements to join
  minSouls      Int      @default(0)
  minElo        Int      @default(0)
  requirePremium Boolean @default(false)

  // Timing
  startsAt      DateTime @default(now())
  endsAt        DateTime

  // Status
  status        String   @default("active") // active, ended, cancelled

  createdAt     DateTime @default(now())

  // Relations
  entries       GiveawayEntry[]
  winners       GiveawayWinner[]
}

model GiveawayEntry {
  id          String   @id @default(cuid())

  giveawayId  String
  giveaway    Giveaway @relation(fields: [giveawayId], references: [id], onDelete: Cascade)

  steamId     String
  username    String

  createdAt   DateTime @default(now())

  @@unique([giveawayId, steamId])
  @@index([giveawayId])
}

model GiveawayWinner {
  id          String   @id @default(cuid())

  giveawayId  String
  giveaway    Giveaway @relation(fields: [giveawayId], references: [id], onDelete: Cascade)

  steamId     String
  username    String

  // For leaderboard type, store placement
  placement   Int      @default(1)

  // Was prize claimed?
  claimed     Boolean  @default(false)
  claimedAt   DateTime?

  createdAt   DateTime @default(now())

  @@index([giveawayId])
}

// News and announcements
model News {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  excerpt     String?  @db.Text

  // Category: update, event, maintenance, announcement
  category    String   @default("announcement")

  // Is pinned to top
  isPinned    Boolean  @default(false)

  // Is published or draft
  isPublished Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
